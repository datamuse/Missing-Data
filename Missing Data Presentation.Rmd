---
title: "Missing Data Modeled"
author: "Patrick Mobley"
date: "March 23, 2016"
output: ioslides_presentation
---
<style>
div.box {
    background-color:lightsteelblue;
    color:black;
    margin:20px;
    padding:20px;
} 

h2 {
    color:slategrey;
}
</style>
## About Me { .flexbox}

<div class="columns-2">
* Moved to the Twin Cities about one year ago
* Masters in Applied Economics from UND
* Research Data Analyst at Allina Health
* Very new to data science

<div class="box" style="font-size:70%;padding:0px;"> 
\@github: datamused

\@LinkedIn: www.linkedin.com/in/patrickdmobley

</div>

<img src="https://avatars3.githubusercontent.com/u/17633513?v=3&s=460" width="300px" height="300px" />
</div>

## Keep in Mind { .flexbox .vcenter}

<div class="centered" style="font-size:130%;">
> All models are wrong, but some are useful 

      â€” famed statistician George Box

</div>

## The data

Iris Data Set 

- Setosa 
- Versicolour 
- Virginica

50 observations each

## Why is missing data a problem? {.smaller .build}

Loss of power

```{r, echo=FALSE, message=FALSE }
rm(list=ls())                        # clear the workspace
require(dplyr, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(gridExtra, quietly = TRUE)
```
```{r, echo=FALSE}
data(iris)
head(iris)
#generate biased missing data
  iris.mis <- as.data.frame(lapply(filter(iris, Petal.Length <= 3.0 ), 
          function(cc) cc[ sample(c(TRUE, NA), 
          prob = c(0.80, 0.20), size = length(cc), replace = TRUE) ]))
  iris.mis <- merge(iris.mis, filter(iris, Petal.Length > 3.0), all = TRUE)
#generate unbiased missing data
  #install.packages("missForest")
  #require(missForest)
  #iris.mis <- prodNA(iris, noNA = .1)
head(iris.mis)
```

+ `r round(100*sum(is.na(unlist(iris.mis)))/length(unlist(iris.mis)), 1)`% of the data is missing.
+ However, only `r nrow(na.omit(iris.mis))` complete rows (`r round((nrow(na.omit(iris.mis))/150*100), 1)`%) are left.

Even small amounts of missing data, can result in large data loss. 

***
Bias

```{r, echo=FALSE}
par(mfrow = c(1,3))
plot(density(iris$Petal.Length), main = "Petal Length")
plot(density(iris.mis$Petal.Length, na.rm = TRUE), main = "Petal Length (missing)")
plot(density(iris.mis$Petal.Length[complete.cases(iris.mis)]), main = "Petal Length (only complete cases)")
par(mfrow = c(1,1))
```

## Goals for Missing Data Models

<div class="box">
1. Minimize bias. 
2. Maximize the use of available information.
3. Yield good estimates of uncertainty. 
</div>

<div style="font-size:70%;">
Taken from Paul Allison's chapter on missing data referenced at end of presentation. 
</div>

<div class="notes">
1. Although it is well-known that missing data can introduce bias into parameter estimates, a good method should make that bias as small as possible.
2. We want to avoid discarding any data, and we want to use the available data to produce parameter estimates that are efficient (i.e., have minimum- sampling variability).
3. We want accurate estimates of standard errors, confidence intervals and p-values.
</div>

## Three types of missing data

- MCAR - Missing Completely At Random 
- MAR - Missing At Random 
- MNAR - Missing Not At Random

They each have different implications. 

## Types of data 

Depending on the type of data, we'll address the missing data differently.

>- Qualitiative 
    - Ordinal (ex: small, medium, large)
    - Categorical (ex: red, green, blue)

>- Quanitative
    - Continuous (ex: age)
    - Discrete (ex: number of people in a household)

## Methods to deal with missing data 

>- Deletion
    - Listwise
    - Pairwise

>- Imputation
    - Mean
    - Median
    - More complex methods

>- Interpolation

## Missing Data Packages in R

>- Imputation
    - Hmisc
    - [missForest](https://stat.ethz.ch/education/semesters/ss2013/ams/paper/missForest_1.2.pdf)
    - [MICE](https://www.jstatsoft.org/index.php/jss/article/view/v045i03/v45i03.pdf)
    - [Amelia](https://cran.r-project.org/web/packages/Amelia/vignettes/amelia.pdf)

>- Tools and visulaization
    - mitools
    - [VIM](http://www.statistik.tuwien.ac.at/forschung/CS/CS-2008-1complete.pdf)

## Visualizing the problem { .smaller}

```{r, message=FALSE, warning=FALSE}
#install.packages("VIM")
require(VIM)
aggr(iris.mis, col=c('steelblue','slategrey'),numbers=TRUE,sortVars=TRUE,
    labels=names(iris.mis),cex.axis=.7,gap=3,ylab=c("Missing Data","Pattern"))
```

## Example in Hmisc
```{r, message=FALSE, warning=FALSE}
#install.packages("Hmisc")
require(Hmisc)
```

`impute()` function replaces the missing value with user defined statistical method (default=median | mean | max etc.)

```{r, results='hide'}
iris.mis$imputed.Petal.Length <- 
              with(iris.mis, impute(Petal.Length, mean))
iris.mis$imputed.Petal.Width <- 
              with(iris.mis, impute(Petal.Width, mean))
```

***
```{r, echo=FALSE, warning=FALSE}
iris.mis$Legend <- ifelse(is.na(iris.mis$Species),
                                "unknown", as.character(iris.mis$Species))
iris.mis$Legend <- ifelse(is.imputed(iris.mis$imputed.Petal.Length) | 
                          is.imputed(iris.mis$imputed.Petal.Width),
                                "imputed", as.character(iris.mis$Legend))
qplot(as.numeric(imputed.Petal.Length), as.numeric(imputed.Petal.Width), 
      data = iris.mis, color=Legend, xlab = "Imputed Petal.Length"
      , ylab = "Imputed Petal.Width")
```

*** 
`aregImpute()` function imputes using additive regression, bootstrapping, and predictive mean matching. 

```{r, results='hide'}
imputed_aregImpute <- aregImpute(~ Sepal.Length + Sepal.Width 
                        + Petal.Length + Petal.Width + Species,
                        data = iris.mis, n.impute = 5)
```
***

```{r, echo=FALSE}
imputed <- as.data.frame(impute.transcan(imputed_aregImpute, 
                           imputation = 1, data = iris.mis, 
                           list.out = TRUE, pr=FALSE, check=FALSE))


plot1 <- qplot(as.numeric(Petal.Length), as.numeric(Petal.Width),
      data = imputed, color = Species, xlab = "Imputed Petal.Length",
      ylab = "Imputed Petal.Width", main = "Imputed") + theme(legend.position="bottom")
plot2 <- qplot(Petal.Length, Petal.Width,
      data = iris, color = Species, main = "Real") + theme(legend.position="bottom")
grid.arrange(plot1, plot2, nrow=1, ncol=2)

```


## Example in missForest

## Example in MICE

```{r, results='hide', message=FALSE, warning=FALSE}
#install.packages("mice")
require(mice)
imputed_mice <- mice(data = iris.mis, m = 5,
                  method = "pmm", maxit=50, seed=500)
```
```{r, echo=FALSE}
summary(imputed_mice)
```


## Questions { .flexbox .vcenter}

<div class="centered" style="width:450px; height=450px">
![](https://openclipart.org/download/69289/confusedpanda.svg)
</div>

## Resources {.smaller}

This presentation:

https://github.com/datamused/Missing-Data

Articles:

http://www.analyticsvidhya.com/blog/2016/03/tutorial-powerful-packages-imputing-missing-values/

http://www.analyticsvidhya.com/blog/2016/01/guide-data-exploration/


Chapters:

http://www.stats.ox.ac.uk/~snijders/Graham2009.pdf

http://www.statisticalhorizons.com/wp-content/uploads/2012/01/Milsap-Allison.pdf

